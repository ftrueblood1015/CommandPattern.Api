@page "/deck"
@page "/deck/{EntityId:int}"

@using CommandPattern.BlazorServer.Shared.Components;
@using CommandPattern.BlazorServer.Shared;
@using CommandPattern.Domain.Entities.Mtg;

@inherits DetailPageBase<Deck>;

<MudText @attributes='Splats.PageHeader("DeckDetail")'>Deck Detail</MudText>

<MudGrid>
    <MudItem xs="12" md="12" lg="12">
        <MudForm @ref="Form" @bind-IsValid="@success">
            <MudPaper Class="pa-4">
                <EntityBaseFrom Entity="@Entity"></EntityBaseFrom>
                <MudGrid>
                    <MudItem xs="12" md="12" lg="6">
                        <EntityBaseSelect TEntity="Format" Title="Format" BoundValue="Entity!.FormatId" HandleChange="FormatChange" DispalyFormat="Name"></EntityBaseSelect>
                    </MudItem>
                    <MudItem xs="12" md="12" lg="6">
                        <EntityBaseSelect TEntity="Guild" Title="Guild" BoundValue="Entity!.GuildId" HandleChange="GuildChange" DispalyFormat="NameDesc"></EntityBaseSelect>
                    </MudItem>
                    <MudItem xs="12" md="12" lg="6">
                        <EntityBaseSelect TEntity="Theme" Title="Theme" BoundValue="Entity!.ThemeId" HandleChange="ThemeChange" DispalyFormat="Name"></EntityBaseSelect>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudPaper Class="pa-4">
                <MudButton @attributes="Splats.NewButton()" OnClick="@(() => Save(Entity!, "decks"))">Save</MudButton>
                <MudButton @attributes="Splats.ResetButton()" OnClick="@(()=>Form!.ResetAsync())" Class="mx-2">Reset</MudButton>
                <MudButton @attributes="Splats.CancelButton()" OnClick="@(() => Cancel("decks"))">Cancel</MudButton>
            </MudPaper>
        </MudForm>
    </MudItem>
    @if (Entity != null && Entity.Id != 0)
    {
        <MudItem xs="12" md="12" lg="6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h4">Win %: @Entity!.WinRate</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="12" lg="6">
            <MudPaper Class="pa-4">
                <MudText @attributes='Splats.PageHeader("DeckCardSummary")'>Card Summary</MudText>
                <MudDataGrid @attributes='Splats.DataGrid("DeckCardSummary")' T="DeckCard" MultiSelection="true" Items="DeckCards" SortMode="SortMode.Multiple"
                             Filterable="true">
                    <ToolBarContent>
                        <MudForm @ref="DeckCardForm" @bind-IsValid="@success">
                            <MudGrid>
                                <MudItem>
                                    <EntityBaseSelect TEntity="Card" Title="Card" BoundValue="DeckCard!.CardId" HandleChange="DeckCardChange" DispalyFormat="Name"></EntityBaseSelect>
                                </MudItem>
                                <MudItem>
                                    <MudNumericField @bind-Value="@DeckCard!.Quantity" @attributes='Splats.NumericRequired("Quantity")' />
                                </MudItem>
                                <MudItem>
                                    <MudButton @attributes="Splats.NewButton()" OnClick="@(() => SaveDeckCard(DeckCard!))">Add</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudForm>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="x => x.Card!.Name" Title="Name" Sortable="false" Filterable="false" />
                        <PropertyColumn Property="x => x.Quantity" Title="Quantity" />
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudStack Row>
                                <MudButton @attributes="Splats.DeleteButton()" Size="@Size.Small" OnClick="@(() => RemoveDeckCard(context.Item))">Remove</MudButton>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="DeckCard" />
                </PagerContent>
            </MudDataGrid>
            </MudPaper>
        </MudItem>
    }
</MudGrid>